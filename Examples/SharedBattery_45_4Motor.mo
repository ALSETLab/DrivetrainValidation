within DrivetrainValidation.Examples;
model SharedBattery_45_4Motor

  extends DymolaModels.Icons.Basic.Example;

  Modelica.Blocks.Sources.BooleanStep rotateCW(startTime=1000,                 startValue=true)
    annotation (Placement(transformation(extent={{-120,-10},{-100,10}})));
  Modelica.Blocks.Sources.Constant dutyCycle(k=0.9) annotation (Placement(transformation(extent={{-120,30},{-100,50}})));
  Drive_45 drive
    annotation (Placement(transformation(extent={{26,12},{56,24}})));
  Battery.Packs.Scaled.ScaledPackCylindric batteryPack(
    N_serialCells=15,
    N_parallelCells=50,
    N_verticalElements=5,
    redeclare Battery.Cells.Variants.DemoCell3dDAF cell)
                                                 annotation (Placement(transformation(extent={{-14,-14},
            {14,14}},
        rotation=270,
        origin={122,8})));
  Modelica.Blocks.Sources.Constant speed(k=500)
    annotation (Placement(transformation(extent={{-74,50},{-54,70}})));
  Modelica.Blocks.Sources.RealExpression speedInput(y=speed.y/drive.machine.data.w_nom)
    annotation (Placement(transformation(extent={{-120,68},{-100,88}})));
  Modelica.Blocks.Sources.Constant speed1(k=400)
    annotation (Placement(transformation(extent={{-118,-76},{-98,-56}})));
  Modelica.Blocks.Sources.Constant tau(k=-0.0296)
    annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
  FMU.Drive_45_FMU_control drive_fmu   annotation (Placement(transformation(extent={{28,-78},
            {60,-62}})));
  Modelica.Blocks.Sources.TimeTable timeTable(table=[0,-1.35525271560688e-18;
        4.15645422884865e-10,-6.09599974616378e-06; 2.49387253730919e-09,-1.53461598260577e-05;
        1.28850081094308e-08,-6.15969537704661e-05; 6.48406859700389e-08,-0.00029285076211604;
        3.24619075273079e-07,-0.00144911576943965; 1.62351102178828e-06,-0.00723033994688006;
        8.11797075436429e-06,-0.0361339394707295; 4.05902694172443e-05,-0.18058891749393;
        0.000121153469772725,-0.538525934201104; 0.000288206241348274,-1.27867492713195;
        0.000586060734911802,-2.59149743406359; 0.000608688298442613,-2.69087227912312;
        0.00060868829844262,-2.69087227912315; 0.00108721940744426,-4.78066466640459;
        0.0014904998452685,-6.5244018713467; 0.00184312855106116,-8.03608227568851;
        0.00216830970474369,-9.41933478348941; 0.00247533972750497,-10.715921487068;
        0.00276892549173245,-11.9471642315379; 0.00305878338560521,-13.1545851006594;
        0.00337908448815874,-14.4793957013595; 0.00373376904961849,-15.9349245354318;
        0.00412673327885162,-17.5334996680783; 0.00456235225992706,-19.2884663142766;
        0.00504554147178322,-21.2142049824225; 0.00558186946988393,-23.3262498368446;
        0.00617763919459775,-25.6412143564807; 0.00684004403713745,-28.1768887135448;
        0.00757727284672358,-30.9521157738055; 0.00839871430640622,-33.9868018693577;
        0.00931518056899362,-37.3017984382003; 0.0103391886180681,-40.9187191012646;
        0.0114853180214585,-44.8596671409027; 0.0120153942670124,-46.644511588439;
        0.0120153942670125,-46.6445115884394; 0.0133007467519482,-50.8746829781009;
        0.0148116820931237,-54.6490467160515; 0.0169327047560028,-58.6431153769521;
        0.0197817938082327,-62.0599727890293; 0.0240565835758694,-64.0675202188167;
        0.0274870807827603,-63.7394054945519; 0.0309175779896513,-62.2634696558974;
        0.0351289698426158,-59.443244600911; 0.0378175884511019,-57.275490287867;
        0.039161897755345,-56.125378654232; 0.0398340524074665,-55.5384465299494;
        0.0399180717389817,-55.4646087564067; 0.0399600814047393,-55.4276531727296;
        0.0399705838211787,-55.418410498554; 0.0399739923090093,-55.4154105282311;
        0.0399739923090097,-55.4154105282307; 0.0399844947254491,-55.4061658639483;
        0.0400370068076461,-55.3599654085039; 0.0402995672186311,-55.1293722549409;
        0.041612369273556,-53.9865790101809; 0.0481763795481803,-48.5200592346355;
        0.0569021127425961,-41.8574644633719; 0.0675097847164023,-34.6094556004242;
        0.0807293684841033,-26.7864515468688; 0.095063092383879,-20.4998915238998;
        0.110495025347341,-15.9753311317546; 0.129930949214134,-12.5395349302627;
        0.155599793085387,-10.3033537415556; 0.191608894598961,-9.32141309989486;
        0.238835064644173,-9.47197311472627; 0.29333222461706,-10.1249743850283;
        0.343793889321194,-10.7011606555318; 0.369024721673261,-10.7950758645064;
        0.394255554025328,-10.9601884556539; 0.433448180785129,-11.0852069745157;
        0.472640807544929,-11.0487112853003; 0.501976990029357,-11.1187092583789;
        0.531313172513784,-10.9121470357194; 0.561136861661366,-10.9086336100519;
        0.59221164831751,-10.6067707791752; 0.621381408708151,-10.5626289715166;
        0.650557862266422,-10.2156546889307; 0.679519897485013,-10.1047083640857;
        0.710286283596279,-9.70857317775998; 0.739977754740299,-9.56843577906721;
        0.769671891555983,-9.1402251805287; 0.798464221721134,-8.97787124693981;
        0.828591221302555,-8.53734582983343; 0.858254247412553,-8.3521738857336;
        0.888412157705364,-7.89221149728758; 0.917480954142853,-7.71146514866338;
        0.947237130862373,-7.25941512074626; 0.976668977383817,-7.07017466296777;
        1.00060868829844,-6.66849061069502; 1.00060868829844,-6.66849061069494;
        1.03084792868681,-6.51549162571306; 1.05892077749967,-6.0742332316891;
        1.08698572852949,-5.90490256324906; 1.11797801357003,-5.48206640603601;
        1.14897047732696,-5.31801956724225; 1.17872349289778,-4.89015586977331;
        1.20702254792946,-4.76925841581305; 1.23641301320358,-4.3920165385978;
        1.2667320962187,-4.25993635982303; 1.29736215106461,-3.87659979110927;
        1.32663253660847,-3.79339291842298; 1.35564476536046,-3.44988277816304;
        1.38513069338978,-3.36796147296994; 1.41554711979125,-3.04011873927695;
        1.44551999266206,-2.99095145715056; 1.474914894053,-2.68289180854421;
        1.5041186107197,-2.65221985037644; 1.53395183693912,-2.37345978571265;
        1.56402425855331,-2.36081682731231; 1.59384230519747,-2.09383961907472;
        1.62324234781079,-2.10730658308072; 1.65273126172479,-1.8673570831062;
        1.68257119625824,-1.89277805282747; 1.7124978577621,-1.66692269132847;
        1.74220236848389,-1.7160709321898; 1.77168256903208,-1.50824438304956;
        1.80132353945228,-1.56923504606369; 1.83111954200865,-1.37827473697153;
        1.86097717344409,-1.45631379123746; 1.8905932881327,-1.27670340628807;
        1.92020587702406,-1.36748609875393; 1.94984884103991,-1.20313093739879;
        1.9796881289867,-1.30482964979479; 2.00940039485988,-1.14928648269793;
        2.03909045383712,-1.26279454651182; 2.06867621998193,-1.11797728733595;
        2.09843630780087,-1.23865614669391; 2.12815368478829,-1.1017649567905;
        2.15791712272089,-1.23140557718145; 2.1875290439065,-1.10090415542225;
        2.21724046138733,-1.23585384532598; 2.24691764296203,-1.11184781788534;
        2.27669926276404,-1.25233621005461; 2.30635769028917,-1.13201376779039;
        2.33606803797815,-1.27658082520174; 2.36571545755063,-1.16050281858966;
        2.3954743702202,-1.30784128080953; 2.42515784363758,-1.1940229510786;
        2.45488651102124,-1.34407009658429; 2.4845337008818,-1.23222306952975;
        2.51426397931839,-1.38332977360165; 2.54394824048329,-1.27276800160435;
        2.57368678878951,-1.42506537549129; 2.60335133587238,-1.31483984303172;
        2.63306671424536,-1.46726162371644; 2.66274408157631,-1.35737079610101;
        2.69247711029192,-1.509673955596; 2.72215858949364,-1.39921057944639;
        2.75187172545088,-1.55104806666962; 2.78154760574363,-1.44003633703147;
        2.81126777146738,-1.59091002870034; 2.84095759499958,-1.47888467545595;
        2.87067173336276,-1.62881946098942; 2.90035331697825,-1.51561516915151;
        2.93006262760964,-1.66419455202883; 2.9597542520542,-1.5497427319495;
        2.98946643961217,-1.69702218758145; 3.01915607936013,-1.58108905830376;
        3.04885986970765,-1.72690822099563; 3.07855189980425,-1.60958891653814;
        3.10825905132591,-1.7539238702489; 3.13795464201228,-1.6350834217065;
        3.1676564931951,-1.77798330577602; 3.19735035006348,-1.65771146431091;
        3.22705215224026,-1.79913180236184; 3.25675051187886,-1.67744372108165;
        3.28645121174162,-1.81751151360435; 3.31614804167525,-1.6944561148995;
        3.34584625825889,-1.83318359099768; 3.37554548872506,-1.70887303818992;
        3.40524454271967,-1.8463759124386; 3.43494404347891,-1.72085534194301;
        3.46464064611133,-1.85721818002792; 3.49434034503059,-1.73062146551273;
        3.52403753157429,-1.86593216085976; 3.5537385254745,-1.73833330537728;
        3.58343461930311,-1.8727139964965; 3.61313496671141,-1.74422709162416;
        3.64283077368755,-1.87775721533579; 3.67253217672855,-1.74848395139398;
        3.70222805563908,-1.88128273860863; 3.73192904971361,-1.75131376561328;
        3.76162427940121,-1.88346693558525; 3.7913255525561,-1.75290964111308;
        3.82102122935685,-1.88451425138269; 3.85072254106684,-1.75344706369114;
        3.88041782273899,-1.88459232333407; 3.91011885534592,-1.75310844307836;
        3.93981443067594,-1.88386999025145; 3.96951564083089,-1.75204241312897;
        3.9992112601599,-1.88250134798906; 4.02891206978679,-1.75040202829054;
        4.0586077692003,-1.88061984544002; 4.08830860043755,-1.74831452453213;
        4.11800460668914,-1.87835563630283; 4.14770516238861,-1.74589783933657;
        4.17740120539334,-1.87581375805691; 4.20710157408258,-1.743256963751;
        4.23679794791744,-1.87309413017815; 4.26649816751808,-1.74047865920365;
        4.29619466556546,-1.87027843229018; 4.32589460355222,-1.73764292270613;
        4.35559134246378,-1.86743719901617; 4.38529116148088,-1.73481191814933;
        4.41498811381863,-1.86463060070556; 4.44468767754965,-1.73204057435834;
        4.47438479237298,-1.86190504919417; 4.50408420672477,-1.72937143467767;
        4.53378155398765,-1.85930036464498; 4.56348078498109,-1.72683781199604;
        4.59317826754781,-1.85684466750686; 4.62287732546287,-1.72446571320264;
        4.65257499957586,-1.85455993924321; 4.68227392969574,-1.72227196346082;
        4.7119717385211,-1.85246047607954; 4.74167050848645,-1.72026862628065;
        4.77136845190706,-1.85055433972127; 4.80106711946637,-1.71846081913324;
        4.83076519034735,-1.84884518468014; 4.86046373610452,-1.71684969062326;
        4.89016189867429,-1.84733137308995; 4.9198603533692,-1.71543225214438;
        4.94955861853416,-1.84600858713082; 4.97925699153746,-1.71420208460885;
        5.00895532346447,-1.84486903379091; 5.03865361940531,-1.71315071194343;
        5.06835202017816,-1.84390300590673; 5.09805026283306,-1.71226721430506;
        5.12774871380118,-1.84309913556735; 5.15744689999525,-1.71153972318572;
        5.18714538960024,-1.8424447321737; 5.21684353942552,-1.71095517875172;
        5.24654206290375,-1.84192667539028; 5.27624017820646,-1.71050011997188;
        5.30593871933011,-1.84153124701938; 5.33563680966331,-1.71016096023292;
        5.36533536737532,-1.84124492801018; 5.39503344058994,-1.70992412043968;
        5.42473200285093,-1.84105433693972; 5.45443006119777,-1.70977654031884;
        5.48412862467988,-1.84094658694788; 5.51382667691341,-1.70970557741855;
        5.54352523611233,-1.84090946349762; 5.57322328277992,-1.7096993866581;
        5.60292183226499,-1.8409314368042; 5.63261987894153,-1.70974688592753;
        5.66231841728338,-1.84100190790135; 5.6920164655846,-1.70983787550992;
        5.72171498795311,-1.84111111689899; 5.75141303976378,-1.7099631103182;
        5.78111154575011,-1.84125028339189; 5.81080960339546,-1.71011424523404;
        5.84050809049576,-1.8414115556098; 5.87020615383593,-1.71028391788289;
        5.89990462135399,-1.8415880073696; 5.92960269206527,-1.7104656532867;
        5.95930113966434,-1.84177363584537; 5.98899921721112,-1.71065387906975;
        6.01869764415684,-1.84196327738635; 6.04839572889901,-1.71084385815508;
        6.07809413593378,-1.84215260285513; 6.10779222753386,-1.71103163222075;
        6.13749061449395,-1.84233802424381; 6.16718871227628,-1.71121398032403;
        6.19688708009405,-1.84251665450636; 6.22658518374967,-1.71138833081004;
        6.2562835330144,-1.84268623641822; 6.28598164147205,-1.71155271954381;
        6.31567997301211,-1.84284507222455; 6.34537808571109,-1.71170570756861;
        6.37507640059883,-1.84299197036168; 6.40477451651811,-1.7118463256046;
        6.43447281555671,-1.84312616861371; 6.46417093384777,-1.71197401073824;
        6.49386921821176,-1.84324728499399; 6.52356733801908,-1.71208854298358;
        6.55326560859241,-1.8433552526006; 6.58296372895069,-1.71218999659035;
        6.6126619867795,-1.84345026918313; 6.64236010693824,-1.7122786813265;
        6.67205835296638,-1.8435327482395; 6.7017564720346,-1.71235510083784;
        6.73145470713268,-1.84360327101858; 6.76115282440737,-1.71241990657383;
        6.7908510494731,-1.84366254992471; 6.8205491642312,-1.71247386050603;
        6.85024737999737,-1.84371138887834; 6.87994549159285,-1.71251780220786;
        6.90964369881759,-1.84375065437934; 6.93934180669391,-1.71255261758846;
        6.96904000600345,-1.84378124689303; 6.9987381096163,-1.71257921578567;
        7.02843630159729,-1.8438040777549; 7.05813440051937,-1.71259850605861;
        7.08783258569086,-1.84382005043635; 7.11753067951028,-1.71261138133023;
        7.14722885830508,-1.843830043534; 7.17692694669549,-1.71261870344593;
        7.20662511951281,-1.84383489919096; 7.23632320219251,-1.71262129186208;
        7.26602136934401,-1.84383541243673; 7.29571944607727,-1.71261991566765;
        7.32541760784101,-1.84383232448823; 7.35511567845199,-1.71261528694586;
        7.3848138350441,-1.84382631769554; 7.41451189938309,-1.71260805745171;
        7.4442100509763,-1.84381801246281; 7.47390810894577,-1.71259881615409;
        7.50360625567647,-1.84380796630432; 7.53330430720276,-1.71258808893873;
        7.56300244916309,-1.84379667369657; 7.59270049420626,-1.71257633939797;
        7.62239863146546,-1.84378456772058; 7.65209667001105,-1.71256397057888;
        7.68179480260425,-1.84377202218982; 7.71149283465598,-1.71255132786005;
        7.74119096259963,-1.84375935476889; 7.77088898818365,-1.71253870212272;
        7.80058711147374,-1.84374683059287; 7.83028513062626,-1.71252633369864;
        7.85998324924251,-1.84373466617894; 7.88968126201459,-1.71251441642003;
        7.91937937592667,-1.84372303375594; 7.94907738237632,-1.71250310194624;
        7.9787754915421,-1.84371206552823; 8.00847349173404,-1.71249250416014;
        8.03817159610698,-1.84370185810753; 8.0678695901109,-1.71248270346414;
        8.09756768963858,-1.84369247678118; 8.12726567752524,-1.71247375106893;
        8.15696377215351,-1.84368395967069; 8.18666175399588,-1.71246567301449;
        8.21635984366995,-1.84367632171174; 8.2460578195394,-1.71245847404455;
        8.27575590420459,-1.84366955834843; 8.30545387417159,-1.71245214118652;
        8.33515195377578,-1.84366364901422; 8.36484991790814,-1.71244664705911;
        8.39454799240127,-1.84365856027531; 8.42424595076359,-1.71244195289956;
        8.45394402009952,-1.84365424870747; 8.48364197275312,-1.71243801126221;
        8.51334003688941,-1.84365066345419; 8.54303798389132,-1.71243476844264;
        8.57273604278986,-1.84364774848575; 8.60243398419329,-1.7124321665833;
        8.63213203782057,-1.8436454445758; 8.66182997367429,-1.71243014550694;
        8.69152802200121,-1.8436436909855; 8.72122595234985,-1.71242864427405;
        8.75092399535207,-1.84364242689757; 8.78062192023617,-1.71242760248291;
        8.81031995789364,-1.84364159259563; 8.84001787734965,-1.71242696134167;
        8.86971590964668,-1.84364113042195; 8.8994138237074,-1.71242666451581;
        8.92911185063237,-1.84364098553138; 8.95880975932692,-1.71242665878911;
        8.98850778087195,-1.8436411064566; 9.01820568422626,-1.71242689454616;
        9.04790370038703,-1.84364144551645; 9.07760159842398,-1.71242732610346;
        9.1072996091993,-1.8436419590753; 9.13699750193907,-1.71242791190884;
        9.16669550733067,-1.84364260768451; 9.19639339479104,-1.71242861462473;
        9.22609139480317,-1.84364335611559; 9.25578927699976,-1.7124294011186;
        9.28548727163892,-1.84364417330879; 9.31518514858552,-1.71243024237197;
        9.34488313786015,-1.84364503224911; 9.37458100956891,-1.71243111332811;
        9.4042789934891,-1.84364590978658; 9.4339768599709,-1.71243199268786;
        9.46367483854812,-1.84364678641347; 9.49337269981266,-1.71243286267049;
        9.52307067305949,-1.8436476460091; 9.55276852911563,-1.71243370874685;
        9.58246649704557,-1.84364847556519; 9.61216434790143,-1.71243451935664;
        9.64186231052865,-1.84364926489712; 9.67156015619182,-1.71243528561813;
        9.70125811353102,-1.84365000635234; 9.73095595400872,-1.71243600103494;
        9.76065390607491,-1.84365069451946; 9.79035174137412,-1.71243666120959;
        9.82004968818254,-1.84365132594501; 9.8497475183101,-1.71243726356474;
        9.87944545987606,-1.84365189886183; 9.90914328483876,-1.7124378070783;
        9.93884122117751,-1.84365241293072; 9.96853904098218,-1.71243829203467;
        10,-1.86087816468827])
    annotation (Placement(transformation(extent={{-60,-44},{-40,-24}})));
  Modelica.Blocks.Math.Feedback feedback
    annotation (Placement(transformation(extent={{-52,-72},{-40,-60}})));
  Modelica.Blocks.Continuous.PID PID(
    k=0.2,
    Ti=1.75,
    Td=0.1,
    initType=Modelica.Blocks.Types.InitPID.SteadyState)
    annotation (Placement(transformation(extent={{-36,-72},{-24,-60}})));
  Modelica.Blocks.Math.Gain gain(k=-1)
    annotation (Placement(transformation(extent={{-12,-92},{-20,-84}})));
equation
  connect(drive.rotateCW_In, rotateCW.y) annotation (Line(points={{27.6667,
          13.7143},{-40,13.7143},{-40,0},{-99,0}},
                                color={255,0,255}));
  connect(drive.dutyCycleIn, dutyCycle.y)
    annotation (Line(points={{27.6667,17.6571},{-99,17.6571},{-99,40}},
                                                             color={0,0,127}));
  connect(drive.pin_p, batteryPack.p) annotation (Line(points={{34.3333,22.2857},
          {34.3333,42},{122,42},{122,22}},
                              color={0,0,255}));
  connect(drive.pin_n, batteryPack.n) annotation (Line(points={{49.1667,22.2857},
          {49.1667,32},{88,32},{88,-16},{122,-16},{122,-6}},
                                                    color={0,0,255}));
  connect(drive_fmu.rotationCW, rotateCW.y) annotation (Line(points={{24.4444,
          -76.72},{-72,-76.72},{-72,0},{-99,0}},
                                           color={255,0,255}));
  connect(timeTable.y, drive_fmu.tau) annotation (Line(points={{-39,-34},{-8,
          -34},{-8,-70.32},{24.4444,-70.32}}, color={0,0,127}));
  connect(feedback.y, PID.u)
    annotation (Line(points={{-40.6,-66},{-37.2,-66}}, color={0,0,127}));
  connect(feedback.u1, speed1.y)
    annotation (Line(points={{-50.8,-66},{-97,-66}}, color={0,0,127}));
  connect(drive_fmu.omega, PID.y) annotation (Line(points={{24.4444,-65.2},{
          0.2222,-65.2},{0.2222,-66},{-23.4,-66}}, color={0,0,127}));
  connect(feedback.u2, gain.y) annotation (Line(points={{-46,-70.8},{-46,-88},{
          -20.4,-88}}, color={0,0,127}));
  connect(gain.u, drive_fmu.omega_out) annotation (Line(points={{-11.2,-88},{66,
          -88},{66,-73.84},{61.7778,-73.84}}, color={0,0,127}));
  annotation (Icon(coordinateSystem(preserveAspectRatio=false,
        extent={{-100,-100},{100,100}},
        initialScale=0.1)),                                      Diagram(coordinateSystem(preserveAspectRatio=false,
        extent={{-160,-100},{160,100}},
        initialScale=0.1)),
    experiment(
      StopTime=10,
      __Dymola_NumberOfIntervals=1000,
      __Dymola_Algorithm="Dassl"),
    __Dymola_Commands(file="modelica://BrushlessDCDrives/Resources/Scripts/ExamplesLevelOfDetail.mos" "plot"),
    Documentation(info="<html>
<p>See <a href=\"BrushlessDCDrives.Examples.LevelOfDetail.ReadMe\">Read me</a> for a description.</p>
</html>"));
end SharedBattery_45_4Motor;
